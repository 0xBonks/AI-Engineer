# ==============================================================================
# Docker Compose Configuration for AI Engineer Learning Repository
# ==============================================================================
#
# This file orchestrates the development environment including:
# - Python development container with JupyterLab
# - Volume mounts for code persistence
# - Environment variable configuration
# - Optional GPU support
#
# ==============================================================================

version: '3.8'

services:
  # Main development environment
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-engineer-jupyter
    
    # Port mappings
    ports:
      - "${DOCKER_PORT:-8888}:8888"  # JupyterLab
    
    # Volume mounts (bind host directory to container)
    volumes:
      # Mount entire repository
      - .:/workspace
      
      # Persist data, models, and cache
      - ./data:/workspace/data
      - ./models:/workspace/models
      - ./.cache:/workspace/.cache
      
      # Persist Jupyter configuration
      - ./.jupyter:/root/.jupyter
    
    # Environment variables from .env file
    env_file:
      - .env
    
    # Additional environment variables
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - PYTHONPATH=/workspace
      - CHROMA_PERSIST_DIRECTORY=/workspace/data/chroma
    
    # Restart policy
    restart: unless-stopped
    
    # Resource limits (adjust based on your system)
    # Uncomment to set limits:
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4'
    #       memory: 8G
    #     reservations:
    #       cpus: '2'
    #       memory: 4G
    
    # GPU support (requires nvidia-docker)
    # Uncomment for GPU access:
    # runtime: nvidia
    # environment:
    #   - NVIDIA_VISIBLE_DEVICES=all
    #   - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/api"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ==============================================================================
# GPU Support Configuration (NVIDIA)
# ==============================================================================
# To enable GPU support:
#
# 1. Install nvidia-docker:
#    https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html
#
# 2. Uncomment the 'runtime' and GPU-related 'environment' variables above
#
# 3. Update Dockerfile to use CUDA base image (see Dockerfile comments)
#
# 4. Verify GPU access in container:
#    docker-compose exec jupyter nvidia-smi
#
# ==============================================================================

# ==============================================================================
# Usage Instructions:
# ==============================================================================
# Start services:
#   docker-compose up -d
#
# View logs:
#   docker-compose logs -f jupyter
#
# Stop services:
#   docker-compose down
#
# Rebuild after dependency changes:
#   docker-compose up -d --build
#
# Execute commands in container:
#   docker-compose exec jupyter bash
#   docker-compose exec jupyter python validate_env.py
#
# Access JupyterLab:
#   http://localhost:8888
# ==============================================================================
